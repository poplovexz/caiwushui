// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user")
  password      String    // 添加密码字段
  accounts      Account[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Enterprise {
  id                String      @id @default(cuid())
  name              String
  unifiedSocialCode String      @unique
  legalPerson       String
  registeredCapital Float
  foundingDate      DateTime
  businessScope     String
  address           String
  contactNumber     String
  email            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?
  taxRecords       TaxRecord[]
  socialRecords    SocialRecord[]
  versionRecords   VersionRecord[]
  taxPaymentFiles  TaxPaymentFile[]
  financeRecords   FinanceRecord[]
  financialReports FinancialReport[]
  taxRefunds       TaxRefund[]
}

model TaxRecord {
  id            String     @id @default(cuid())
  enterpriseId  String
  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id])
  year          Int
  month         Int
  taxableIncome Float
  taxAmount     Float
  paidAmount    Float
  taxType       String
  paymentStatus String
  dueDate       String
  paymentDate   String?
  remarks       String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?
  taxNumber     String     // 添加税号字段
  taxRefund     TaxRefund? @relation(fields: [taxRefundId], references: [id])
  taxRefundId   String?

  @@index([enterpriseId])
  @@index([year, month])
  @@index([taxType])
  @@index([paymentStatus])
  @@index([taxRefundId])
}

model SocialRecord {
  id            String      @id @default(cuid())
  enterpriseId  String
  enterprise    Enterprise  @relation(fields: [enterpriseId], references: [id])
  employeeName  String
  idNumber      String
  insuranceType String
  baseAmount    Float
  personalAmount Float
  companyAmount Float
  totalAmount   Float
  paymentStatus String
  paymentDate   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?
}

model VersionRecord {
  id            String      @id @default(cuid())
  enterpriseId  String
  enterprise    Enterprise  @relation(fields: [enterpriseId], references: [id])
  fileName      String
  fileType      String      // 文件类型，如 pdf, doc 等
  fileSize      Int         // 文件大小，单位字节
  fileUrl       String      // 文件存储路径
  version       String      // 版本号
  status        String      // 状态：待审核、已通过、已驳回
  uploadTime    DateTime    @default(now())
  reviewTime    DateTime?   // 审核时间
  reviewResult  String?     // 审核结果
  reviewComment String?     // 审核意见
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  @@index([enterpriseId])
  @@index([status])
  @@index([uploadTime])
}

model TaxPaymentFile {
  id              String    @id @default(cuid())
  fileName        String    // 文件名称
  fileType        String    // 文件类型
  processStatus   String    // 处理状态：待处理、处理中、已处理
  processTime     DateTime? // 处理时间
  serialNumber    String    // NO编号
  enterpriseId    String    // 关联企业ID
  enterprise      Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  taxpayerId      String    // 纳税人识别号
  totalAmount     Float     // 合计金额
  uploadTime      DateTime  @default(now()) // 上传时间
  filePath        String    // 文件存储路径
  remarks         String?   // 备注
  
  @@index([enterpriseId])
  @@index([processStatus])
  @@index([uploadTime])
}

model FinanceRecord {
  id           String    @id @default(cuid())
  fileName     String
  taxNumber    Decimal   @db.Decimal(10, 2)
  year         String
  period       String
  taxpayerId   String
  uploadTime   DateTime
  processStatus String   // 未处理、处理中、已处理
  taxpayerName String
  processType  String    // 人工处理、自动处理
  filePath     String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  processTime  DateTime?
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  @@index([taxpayerId])
  @@index([processStatus])
  @@index([uploadTime])
  @@index([enterpriseId])
}

model FinancialReport {
  id             String    @id @default(cuid())
  fileName       String    // 文件名称
  reportType     String    // 报表类型：资产负债表、利润表、现金流量表等
  year           String    // 年度
  quarter        String    // 季度：Q1、Q2、Q3、Q4
  period         String    // 所属期间
  totalAssets    Decimal   @db.Decimal(15, 2)  // 总资产
  totalLiability Decimal   @db.Decimal(15, 2)  // 总负债
  netAssets     Decimal   @db.Decimal(15, 2)  // 净资产
  revenue       Decimal   @db.Decimal(15, 2)  // 营业收入
  profit        Decimal   @db.Decimal(15, 2)  // 净利润
  uploadTime    DateTime  // 上传时间
  processStatus String    // 处理状态：未处理、处理中、已处理
  processType   String    // 处理方式：人工处理、自动处理
  filePath      String    // 文件路径
  remarks       String?   // 备注
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  processTime   DateTime? // 处理时间
  enterpriseId  String    // 关联企业ID
  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id])

  @@index([enterpriseId])
  @@index([processStatus])
  @@index([uploadTime])
  @@index([year, quarter])
}

model TaxRefund {
  id             String      @id @default(cuid())
  taxNumber      String
  taxPeriod      String
  taxAmount      Decimal     @db.Decimal(15, 2)
  baseAmount     Decimal     @db.Decimal(15, 2)
  refundRate     Decimal     @db.Decimal(5, 2)
  refundAmount   Decimal     @db.Decimal(15, 2)
  personalAmount Decimal     @db.Decimal(15, 2)
  companyAmount  Decimal     @db.Decimal(15, 2)
  landAmount     Decimal     @db.Decimal(15, 2)
  propertyAmount Decimal     @db.Decimal(15, 2)
  otherAmount    Decimal     @db.Decimal(15, 2)
  totalAmount    Decimal     @db.Decimal(15, 2)
  status         String      // 未处理、处理中、已处理
  enterpriseId   String
  enterprise     Enterprise  @relation(fields: [enterpriseId], references: [id])
  taxRecords     TaxRecord[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([enterpriseId])
  @@index([status])
  @@index([taxPeriod])
}

model TaxRefundConfig {
  id        String   @id @default(cuid())
  name      String   // 企业所得税、个人所得税等
  rate      Decimal  @db.Decimal(5, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}
